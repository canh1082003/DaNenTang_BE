// import { Zalo } from 'zca-js';
// import express, { Application, Request, Response } from 'express';
// import dotenv from 'dotenv';
// import User from '@/databases/entities/User';
// import Conversation from '@/databases/entities/Conversation';
// import Message from '@/databases/entities/Message';
// import chatService from '../Chat/chatService';

// dotenv.config();

// /**
//  * Zalo Bot (v2.0.4) â€” Gá»­i tin nháº¯n + mÃ´ phá»ng inbound
//  */
// export const initZaloBot = async (io?: any) => {
//   const app: Application = express();
//   app.use(express.json());

//   const account = process.env.ZALO_PHONE || '000';
//   const password = process.env.ZALO_PASSWORD;

//   if (!account || !password) {
//     console.error('âŒ Thiáº¿u ZALO_PHONE hoáº·c ZALO_PASSWORD trong .env');
//     return;
//   }

//   const zalo = new Zalo();

//   console.log('ğŸ” Äang Ä‘Äƒng nháº­p Zalo...');

//   try {
//     const api = await zalo.login({ account, password });

//     console.log('âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng!');
//     if (io) io.emit('zalo_status', { status: 'ready' });

//     // ======================================
//     // ğŸ“¨ API Gá»¬I TIN NHáº®N
//     // ======================================
//     app.post('/api/zalo/send', async (req: Request, res: Response) => {
//       const { userId, text } = req.body;
//       if (!userId || !text) {
//         return res.status(400).json({ error: 'Thiáº¿u userId hoáº·c text' });
//       }

//       try {
//         await api.message.sendText(userId, text);
//         res.json({ success: true });
//       } catch (err) {
//         console.error('âŒ Lá»—i gá»­i tin:', err);
//         res.status(500).json({ error: String(err) });
//       }
//     });

//     // ======================================
//     // ğŸ“¥ MÃ” PHá»NG NHáº¬N TIN NHáº®N INBOUND (webhook)
//     // ======================================
//     app.post('/api/zalo/inbound', async (req: Request, res: Response) => {
//       try {
//         const { senderId, text } = req.body;
//         if (!senderId || !text) {
//           return res.status(400).json({ error: 'Thiáº¿u senderId hoáº·c text' });
//         }

//         console.log('ğŸ“© [Inbound] Tin nháº¯n má»›i:', text, 'tá»«', senderId);

//         // 1ï¸âƒ£ TÃ¬m hoáº·c táº¡o user
//         let user = await User.findOne({ zaloId: senderId });
//         if (!user) {
//           user = await User.create({
//             zaloId: senderId,
//             username: `zalo_${senderId}`,
//             email: `${senderId}@zalo.local`,
//             password: `zalo_${Date.now()}`,
//           });
//         }

//         // 2ï¸âƒ£ TÃ¬m hoáº·c táº¡o conversation
//         let conversation = await Conversation.findOne({
//           type: 'group',
//           participants: { $all: [user._id, process.env.BOT_USER_ID] },
//         });

//         if (!conversation) {
//           conversation = await Conversation.create({
//             type: 'group',
//             participants: [user._id, process.env.BOT_USER_ID],
//           });
//         }

//         // 3ï¸âƒ£ LÆ°u message
//         const message = await chatService.SendMessage(
//           {
//             conversationId: conversation.id.toString(),
//             content: text,
//             type: 'text',
//           },
//           user.id.toString()
//         );

//         const populatedMessage = await Message.findById(message._id)
//           .populate('sender', 'username avatar _id')
//           .lean();

//         // 4ï¸âƒ£ Push ra socket realtime
//         io.to(conversation.id.toString()).emit('newMessage', populatedMessage);
//         conversation.participants.forEach((p: any) => {
//           io.to(p._id.toString()).emit('newMessagePreview', populatedMessage);
//         });

//         res.json({ success: true });
//       } catch (err) {
//         console.error('âŒ Lá»—i inbound message:', err);
//         res.status(500).json({ error: String(err) });
//       }
//     });

//     // ======================================
//     console.log('ğŸ¤– Zalo Bot (v2.0.4) sáºµn sÃ ng!');
//   } catch (err) {
//     console.error('âŒ ÄÄƒng nháº­p Zalo tháº¥t báº¡i:', err);
//   }
// };
